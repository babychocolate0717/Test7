
events {}

http {
    # 定義後端伺服器群組
    upstream ingestion_backend {
        server ingestion:8000;
        server ingestion-2:8000;
        server ingestion-3:8000;
    }

    server {
        listen 80; # Nginx 容器內部監聽 80 port

        # 將所有 API 請求代理到後端
        location / {
            proxy_pass http://ingestion_backend;
            
            # 【關鍵修復】確保 Authorization 標頭被轉發
            proxy_set_header Authorization $http_authorization; 

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- 新增區塊：開啟 Nginx 狀態頁面 ---
        # 這個頁面只在 Docker 內部網路中可見，專門給 Exporter 使用
        location /stub_status {
            stub_status;
            allow 127.0.0.1; # 允許本機訪問
            allow all;       # 允許所有 Docker 內部網路訪問
            deny all;        # 拒絕其他所有連線
        }
    }
}